# Курьер сервис API

## Описание

Этот проект представляет собой API для автоматизированного получения заказов в курьерской компании. API реализован на
Django Rest Framework (DRF) и позволяет выполнять следующие операции с заявками:

- Создание заявки
- Обновление заявки
- Получение статуса заявки
- Завершение заявки

API также выполняет валидацию адресов с использованием сервиса [Dadata](https://dadata.ru/api/suggest/address/),
рассчитывает расстояние от склада до адреса доставки и применяет бизнес-правила для обработки различных типов посылок.

## Функционал API

1. **Создание заявки**:  
   Позволяет создать новую заявку на доставку. Адрес проверяется и корректируется через Dadata API, а расстояние от
   склада до места доставки рассчитывается автоматически.

   Пример запроса:

   __POST /api/orders/__

   ```json
    {
        "city": "Казань",
        "address": "ул Нариманова, д 50",
        "delivery_date": "2024-09-30",
        "delivery_time": "18:00:00",
        "customer": "ООО Ромашка",
        "comment": "Оставить у двери",
        "package_type": "Письмо"
    }
    ```
   Пример ответа:
    ```json
    {
        "order": 5
    }
    ```
2. **Обновление заявки**:
   Позволяет обновить существующую заявку. Адрес снова проверяется через Dadata API, а расстояние пересчитывается при
   изменении адреса доставки.

   Пример запроса:

   __PUT /api/orders/5/__

   ```json
    
    {
        "city": "Казань",
        "address": "ул Ленина, д 100",
        "delivery_date": "2024-10-01",
        "delivery_time": "12:00:00",
        "customer": "ООО Василек",
        "comment": "Позвонить перед доставкой",
        "package_type": "bulk"
    }
    ```
   Пример ответа:

   ```json
   {
       "status": "Заявка обновлена"
   }
   ```
3. **Получение статуса заявки**:
   Позволяет получить текущий статус заявки по её ID.

   Пример запроса:

   __GET /api/orders/5/status/__

   Пример ответа:

   ```json
   {
      "status": "New"
   }
   ```
4. **Завершение заявки**:
   Позволяет завершить заявку.

   Пример запроса:

   __POST /api/orders/5/complete/__

   Пример ответа:

   ```json
    {
      "status": "Заказ завершен"
    }
    ```
   Но, если заявка и так уже была завершена, то вернет другой ответ:

   ```json
   {
      "error": "Заявка уже завершена"
   }
   ```

## Бизнес-правила

* Компания работает только в городах Татарстана: Казань, Набережные Челны, Нижнекамск, Альметьевск, Зеленодольск.
* Тип посылки «Габаритный груз» доставляется только в Казани.
* Адрес доставки корректируется через Dadata API, и для каждого заказа рассчитывается расстояние от склада компании.

## Стек технологий

* Python 3.10
* Django 5.1.1
* Django REST framework 3.14.0
* DaData API для валидации адресов
* Geopy для расчёта расстояний
* Pandas для работы с таблицами
* Openpyxl для работы с таблицами
* Coverage для подсчета покрытия
* PostgreSQL для работы с базой данных

## Локальный запуск

1. **Клонирование репозитория**

```
git clone https://github.com/denimani/courier_service.git
```

2. **Установка зависимостей**

Создайте виртуальное окружение и активируйте его:

```
python -m venv venv
source venv/bin/activate # для Linux и macOS
venv\Scripts\activate # для Windows
```
Установите зависимости:
```
pip install -r requirements.txt
```

3. **Настройка переменных окружения**

Создайте файл .env в корне проекта и добавьте в него данные вашей базы и API ключ от DaData:
```
# настройка базы данных
POSTGRES_DB=
POSTGRES_USER=
POSTGRES_PASSWORD=
POSTGRES_HOST=
POSTGRES_PORT=

# ключи DaData
DADATA_API_KEY=
```
4. **Применение миграций**

Примените миграции базы данных:
```
python manage.py migrate
```
5. **Заполнение базы данных**

Для заполнения базы данных данными из файла DeliveryData.xlsx выполните команду:
```
python manage.py import_excel
```

6. **Запуск сервера разработки**

Запустите сервер:
```
python manage.py runserver
```

## Запуск с Docker
1. **Скопируйте репозиторий:**

```
git clone https://github.com/denimani/courier_service.git
```

2. **Создайте файл `.env` для хранения переменных окружения:**

```
# настройка базы данных
POSTGRES_DB=
POSTGRES_USER=
POSTGRES_PASSWORD=
POSTGRES_HOST=
POSTGRES_PORT=

# ключи DaData
DADATA_API_KEY=
```

3. **Запуск с помощью Docker Compose:**

В корневой директории проекта выполните команду:

```
docker-compose up --build
```

Это создаст и запустит контейнеры для вашего Django-приложения и базы данных.

4. **Заполнение базы данных**

Для заполнения базы данных данными из файла DeliveryData.xlsx выполните команду:

```
docker exec -it app python manage.py import_excel
```

## Тестирование

Для тестирования проекта запустить команду:

```
python manage.py test
```
Для запуска подсчета покрытия и вывода отчет запустить команды:

```
coverage run --source='./orders' manage.py test
coverage report
```

## SQL-запросы

Запросы SQL из второй части задания можно посмотреть в файле commands.sql.

### API будет доступен по адресу http://127.0.0.1:8000/api/.
